<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spr√°vce liter√°rn√≠ch rozbor≈Ø</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Oddƒõleno: pokud Tailwind CDN sel≈æe, tahle chyba nezabije dark mode
        try {
            tailwind.config = { darkMode: 'class' };
        } catch(e) {
            console.warn('Tailwind CDN se nenaƒçetl:', e.message);
        }
    </script>
    <script>
        // Separ√°tn√≠ blok ‚Äî v≈ædy se spust√≠, i kdy≈æ Tailwind padne
        (function() {
            var saved = localStorage.getItem('theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        textarea::-webkit-scrollbar, .max-h-\[40vh\]::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track, .max-h-\[40vh\]::-webkit-scrollbar-track { background: #f1f1f1; }
        textarea::-webkit-scrollbar-thumb, .max-h-\[40vh\]::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover, .max-h-\[40vh\]::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .dark textarea::-webkit-scrollbar-track, .dark .max-h-\[40vh\]::-webkit-scrollbar-track { background: #1e293b; }
        .dark textarea::-webkit-scrollbar-thumb, .dark .max-h-\[40vh\]::-webkit-scrollbar-thumb { background: #475569; }
        .dark textarea::-webkit-scrollbar-thumb:hover, .dark .max-h-\[40vh\]::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .item-active { background-color: #eff6ff !important; border-left: 4px solid #2563eb !important; }
        .dark .item-active { background-color: #1e3a5f !important; border-left: 4px solid #3b82f6 !important; }
        .list-item { border-left: 4px solid transparent; }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .theme-toggle { position: relative; width: 56px; height: 28px; background: #cbd5e1; border-radius: 9999px; cursor: pointer; transition: background 0.3s; border: none; outline: none; }
        .dark .theme-toggle { background: #475569; }
        .theme-toggle::after { content: '‚òÄÔ∏è'; position: absolute; top: 2px; left: 2px; width: 24px; height: 24px; background: white; border-radius: 9999px; transition: transform 0.3s, background 0.3s; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .dark .theme-toggle::after { content: 'üåô'; transform: translateX(28px); background: #1e293b; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="flex flex-wrap justify-between items-center mb-8 border-b border-slate-200 dark:border-slate-700 pb-4 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">üìö Spr√°vce liter√°rn√≠ch rozbor≈Ø</h1>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Tv≈Øj profesion√°ln√≠ pomocn√≠ƒçek s rozbory</p>
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="theme-toggle" title="P≈ôepnout svƒõtl√Ω/tmav√Ω re≈æim" aria-label="P≈ôepnout tmav√Ω re≈æim"></button>
                <a href="https://github.com/SimonPoky/Literarni-rozbory" target="_blank" class="text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors flex items-center gap-2">
                    <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                    SimonPoky/Literarni-rozbory
                </a>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <form id="analysis-form" class="space-y-8">
                    <input type="hidden" name="id" id="entry-id">

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-4 border-b dark:border-slate-600 pb-2">Identifikace d√≠la</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-2 md:col-span-1">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">N√°zev d√≠la</label>
                                <textarea name="title" required rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2 resize-y"></textarea>
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Autor</label>
                                <textarea name="author" required rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2 resize-y"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-6 border-b dark:border-slate-600 pb-2 uppercase tracking-wide">I. Text a jeho slo≈æky ‚Äì ƒåeho si v≈°√≠mat</h2>

                        <div class="mb-6">
                            <label class="block text-sm font-bold text-blue-800 dark:text-blue-400 mb-1">Liter√°rn√≠ druh a ≈æ√°nr</label>
                            <textarea name="kind_genre" rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 resize-y" placeholder="lyrika, pr√≥za, balada, rom√°n, pov√≠dka apod."></textarea>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-bold text-blue-800 dark:text-blue-400 mb-1">Kontext</label>
                            <textarea name="context" rows="5" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2" placeholder="autor, recepce d√≠la, liter√°rn√≠ obdob√≠, liter√°rn√≠ smƒõr apod."></textarea>
                        </div>

                        <div class="mb-6 border-l-4 border-blue-100 dark:border-blue-800 pl-4 py-1">
                            <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 mb-3">Obsah</h3>
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">T√©ma</label>
                                <textarea name="theme" rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 resize-y" placeholder="hlavn√≠, vedlej≈°√≠ apod."></textarea>
                            </div>
                            <div class="space-y-4">
                                <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide border-b border-slate-200 dark:border-slate-600 pb-1">Vƒõcn√Ω obsah</h4>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Postavy</label>
                                    <textarea name="characters" rows="2" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2" placeholder="hlavn√≠/vedlej≈°√≠; popis, charakteristika, v√Ωvoj, vztahy..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Vypravƒõƒç / Lyrick√Ω subjekt</label>
                                    <textarea name="narrator" rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 resize-y" placeholder="ich-forma, v≈°evƒõdouc√≠, vztah ke ƒçten√°≈ôi..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ƒåasoprostor</label>
                                    <textarea name="setting" rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 resize-y" placeholder="ƒças a prost≈ôed√≠ (m√≠stn√≠, soci√°ln√≠)"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Dƒõj / Dƒõn√≠</label>
                                    <textarea name="plot" rows="3" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2" placeholder="p≈ôevypr√°vƒõn√≠, motivy, ud√°losti, z√°pletka, rozuzlen√≠..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">My≈°lenkov√Ω a emoƒçn√≠ obsah</label>
                                    <textarea name="thought_content" rows="2" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2" placeholder="vidƒõn√≠ svƒõta, ponauƒçen√≠, smysl, celkov√© p≈Øsoben√≠..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2 border-l-4 border-blue-100 dark:border-blue-800 pl-4 py-1">
                            <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 mb-3">Forma</h3>
                            <div class="space-y-4 mb-6">
                                <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide border-b border-slate-200 dark:border-slate-600 pb-1">Kompozice</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ƒålenƒõn√≠ textu</label>
                                        <textarea name="composition_structure" rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 resize-y" placeholder="kapitoly, strofy, dƒõjstv√≠..."></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Slohov√© postupy</label>
                                        <textarea name="style_procedures" rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 resize-y" placeholder="vypr√°vƒõn√≠, popis, charakteristika, √∫vaha; kombinace..."></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Kompoziƒçn√≠ postupy</label>
                                        <textarea name="composition_procedures" rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 resize-y" placeholder="chronologick√Ω, retrospektivn√≠..."></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Kompoziƒçn√≠ principy</label>
                                        <textarea name="composition_principles" rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 resize-y" placeholder="opakov√°n√≠, kontrast..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide border-b border-slate-200 dark:border-slate-600 pb-1">V√Ωrazov√© prost≈ôedky</h4>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Neverb√°ln√≠</label>
                                    <textarea name="nonverbal" rows="1" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 resize-y" placeholder="ilustrace, grafick√° √∫prava textu..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Verb√°ln√≠</label>
                                    <textarea name="verbal" rows="4" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 resize-y" placeholder="spisovnost, archaismy/neologismy, citov√© zabarven√≠, funkƒçnƒõstylov√° p≈ô√≠slu≈°nost, p≈Øvod, syntax, figury, tropy..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-6 border-b dark:border-slate-600 pb-2 uppercase tracking-wide">II. Koment√°≈ô ‚Äì Jak o textu p≈ôem√Ω≈°let</h2>
                        <div class="space-y-6">
                            <div class="bg-blue-50 dark:bg-blue-950/40 p-4 rounded-lg border border-blue-100 dark:border-blue-800">
                                <label class="block text-sm font-bold text-blue-800 dark:text-blue-400 mb-1">V√Ωklad (PROƒå a SMYSL)</label>
                                <p class="text-xs text-slate-600 dark:text-slate-400 mb-2 leading-relaxed">
                                    Nejen CO tam je, ale PROƒå. Smysl/v√Ωznam.<br>
                                    <i>Nap≈ô: Proƒç zvolil tento ≈æ√°nr? Motivace postav? Smysl postavy v textu? Smysl ƒçasu/prostoru? Proƒç t√©ma pojal takto? Smysl kompozice? Co je dominantn√≠ a proƒç?</i>
                                </p>
                                <textarea name="interpretation" rows="6" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2 focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-blue-800 dark:text-blue-400 mb-1">Hodnocen√≠</label>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Posouzen√≠ klad≈Ø a z√°por≈Ø textu a jeho slo≈æek.</p>
                                <textarea name="evaluation" rows="2" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm border p-2"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow transition-all transform active:scale-[0.98]">
                            üíæ Ulo≈æit Rozbor
                        </button>
                        <button type="button" id="btn-reset" class="px-6 py-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-medium rounded-lg transition-colors">
                            Nov√Ω
                        </button>
                    </div>
                </form>
            </div>

            <!-- SIDEBAR -->
            <div class="lg:col-span-1">
                <div class="sticky top-8 space-y-6">
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <button type="button" id="btn-save-sidebar" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow transition-all transform active:scale-[0.98] flex items-center justify-center gap-2">
                            üíæ Rychl√© ulo≈æen√≠
                        </button>
                    </div>

                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/80 flex justify-between items-center">
                            <h3 class="font-semibold text-slate-800 dark:text-slate-200">Ulo≈æeno (<span id="count">0</span>)</h3>
                            <button id="btn-nuke" class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium">Smazat v≈°e</button>
                        </div>
                        <div id="list-container" class="max-h-[40vh] overflow-y-auto divide-y divide-slate-100 dark:divide-slate-700"></div>
                    </div>

                    <div class="bg-slate-50 dark:bg-slate-800/60 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
                        <h3 class="font-bold text-lg mb-2 text-slate-700 dark:text-slate-200">Data &amp; Z√°loha</h3>
                        <p class="text-slate-500 dark:text-slate-400 text-sm mb-4">Prevence proti ztr√°tƒõ dat. St√°hni si JSON a mƒõj klid.</p>
                        <div class="flex gap-2">
                            <button id="btn-backup" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-medium py-2 px-3 rounded text-sm transition-colors">‚¨áÔ∏è Export</button>
                            <button onclick="document.getElementById('import-file').click()" class="flex-1 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-medium py-2 px-3 rounded text-sm transition-colors">‚¨ÜÔ∏è Import</button>
                            <input type="file" id="import-file" class="hidden" accept=".json">
                        </div>
                    </div>

                    <div class="bg-slate-50 dark:bg-slate-800/60 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
                        <h3 class="font-bold text-lg mb-2 text-slate-700 dark:text-slate-200">Export PDF</h3>
                        <p class="text-slate-500 dark:text-slate-400 text-sm mb-4">Vygeneruje kompletn√≠ sborn√≠k pro XeLaTeX p≈ôesnƒõ dle ≈°koln√≠ struktury.</p>
                        <button id="btn-generate" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow transition-colors flex items-center justify-center gap-2">
                            <span>‚ö° Generovat LaTeX</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LATEX MODAL -->
    <div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-11/12 max-w-4xl flex flex-col max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-800 z-10">
                <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 flex items-center gap-2">üìÑ LaTeX V√Ωstup</h3>
                <button id="btn-close-modal" class="text-slate-400 hover:text-red-500 dark:text-slate-500 dark:hover:text-red-400 text-2xl leading-none transition-colors">&times;</button>
            </div>
            <div class="bg-red-50 dark:bg-red-950/50 border-l-8 border-red-600 p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0"><span class="text-red-600 text-2xl animate-pulse">‚ö†Ô∏è</span></div>
                    <div class="ml-3">
                        <p class="text-sm font-bold text-red-900 dark:text-red-300 uppercase tracking-wide">Fat√°ln√≠ chyba nastaven√≠ Overleafu</p>
                        <p class="text-sm text-red-800 dark:text-red-400 mt-1">Tento k√≥d <strong>NEBUDE FUNGOVAT</strong>, pokud ruƒçnƒõ nezmƒõn√≠te kompil√°tor na <span class="bg-red-200 dark:bg-red-800 px-1 rounded font-black">XeLaTeX</span>. V√Ωchoz√≠ pdfLaTeX neum√≠ ƒçesk√© fonty.</p>
                        <p class="text-xs text-red-600 dark:text-red-500 mt-2">Menu (vlevo naho≈ôe) &rarr; Compiler &rarr; XeLaTeX</p>
                    </div>
                </div>
            </div>
            <div class="flex-1 p-0 relative min-h-0">
                <textarea id="output-code" class="w-full h-full p-4 font-mono text-xs bg-slate-50 dark:bg-slate-900 dark:text-slate-300 resize-none focus:outline-none text-slate-700" readonly></textarea>
            </div>
            <div class="p-4 border-t dark:border-slate-700 bg-white dark:bg-slate-800 z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <label class="mb-4 flex items-center justify-end gap-2 bg-red-50 dark:bg-red-950/40 p-3 rounded border border-red-100 dark:border-red-800 hover:bg-red-100 dark:hover:bg-red-950/60 transition-colors cursor-pointer select-none">
                    <input type="checkbox" id="acknowledge-check" class="w-5 h-5 text-red-600 rounded border-gray-300 dark:border-slate-600 focus:ring-red-500 cursor-pointer">
                    <span class="ml-2 block text-sm font-bold text-red-900 dark:text-red-300">Rozum√≠m, ≈æe mus√≠m v Overleafu p≈ôepnout na XeLaTeX, jinak to bouchne.</span>
                </label>
                <div class="flex flex-col sm:flex-row justify-end gap-3">
                    <button id="btn-copy" disabled class="px-4 py-2.5 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition-all text-sm font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">üìã Pouze zkop√≠rovat</button>
                    <button id="btn-overleaf" disabled class="px-4 py-2.5 bg-green-700 hover:bg-green-800 text-white rounded-lg shadow-md hover:shadow-lg transition-all text-sm font-bold flex items-center justify-center gap-2 group disabled:bg-slate-400 dark:disabled:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed">
                        <span>Zkop√≠rovat &amp; Otev≈ô√≠t Overleaf</span>
                        <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- IMPORT MODAL -->
    <div id="import-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-96 max-w-full overflow-hidden transform transition-all scale-100">
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900/50 mb-4">
                    <svg class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-slate-100" id="import-title">Nalezeno dat: <span id="import-count">0</span></h3>
                <div class="mt-2"><p class="text-sm text-gray-500 dark:text-slate-400">Jak chce≈° s nov√Ωmi daty nalo≈æit?</p></div>
            </div>
            <div class="bg-gray-50 dark:bg-slate-800/80 px-4 py-3 sm:px-6 sm:flex sm:flex-col sm:gap-3">
                <button id="btn-import-merge" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">Slouƒçit (Bezpeƒçn√©)</button>
                <p class="text-xs text-center text-gray-400 dark:text-slate-500">Zachov√° existuj√≠c√≠, p≈ôid√° nov√©.</p>
                <button id="btn-import-overwrite" class="mt-3 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm sm:mt-0">P≈ôepsat v≈°e (Smazat star√©)</button>
                <p class="text-xs text-center text-gray-400 dark:text-slate-500">Sma≈æe aktu√°ln√≠ data a nahrad√≠ je.</p>
                <button id="btn-import-cancel" class="mt-4 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-slate-600 shadow-sm px-4 py-2 bg-white dark:bg-slate-700 text-base font-medium text-gray-700 dark:text-slate-200 hover:bg-gray-50 dark:hover:bg-slate-600 focus:outline-none sm:text-sm">Zru≈°it</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    "use strict";

    // ‚îÄ‚îÄ Auto-resize ‚îÄ‚îÄ
    const autoResize = (el) => {
        if (!el) return;
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    };

    document.querySelectorAll('#analysis-form textarea').forEach(ta => {
        ta.style.overflow = 'hidden';
        ta.style.resize = 'none';
        ta.addEventListener('input', () => autoResize(ta));
        setTimeout(() => autoResize(ta), 0);
    });

    // ‚îÄ‚îÄ Dark mode ‚îÄ‚îÄ
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });
    }

    // ‚îÄ‚îÄ Config ‚îÄ‚îÄ
    const DB_KEY = 'literarni_spravce_db_v4';
    const form = document.getElementById('analysis-form');
    const listContainer = document.getElementById('list-container');
    let db = [];
    let importedDataTemp = null;

    const uuid = () => {
        try { return crypto.randomUUID(); }
        catch(e) { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
    };

    // ‚îÄ‚îÄ Data ‚îÄ‚îÄ
    const initData = () => {
        try {
            const raw = localStorage.getItem(DB_KEY);
            db = JSON.parse(raw || '[]');
            if (!Array.isArray(db)) { db = []; }

            let migrated = false;
            db = db.map(item => {
                if (!item || typeof item !== 'object') return null;
                if (!item.uid) { item.uid = uuid(); migrated = true; }
                if (!item.title) item.title = '(bez n√°zvu)';
                if (!item.author) item.author = '(bez autora)';
                return item;
            }).filter(Boolean);

            if (migrated) saveToDb();
        } catch (e) {
            console.error('Data load error ‚Äì resetting:', e);
            db = [];
        }
    };

    const saveToDb = () => {
        try {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            renderList();
        } catch (e) {
            alert('Chyba: localStorage je pln√Ω!');
        }
    };

    // ‚îÄ‚îÄ Render List ‚îÄ‚îÄ
    const renderList = (activeId = null) => {
        if (!listContainer) return;

        const countEl = document.getElementById('count');
        if (countEl) countEl.textContent = db.length;
        listContainer.innerHTML = '';

        if (!db.length) {
            listContainer.innerHTML = '<div class="p-4 text-sm text-slate-400 dark:text-slate-500 text-center">≈Ω√°dn√© ulo≈æen√© rozbory.</div>';
            return;
        }

        const sorted = [...db].sort((a, b) => {
            const tA = (a && a.title) ? a.title : '';
            const tB = (b && b.title) ? b.title : '';
            return tA.localeCompare(tB, 'cs');
        });

        sorted.forEach((item) => {
            if (!item || !item.uid) return;

            const wrapper = document.createElement('div');
            wrapper.className = 'list-item p-3 hover:bg-blue-50 dark:hover:bg-slate-700 transition-colors group flex justify-between items-center border-b border-slate-50 dark:border-slate-700 last:border-0';
            wrapper.dataset.uid = item.uid;
            if (activeId === item.uid) wrapper.classList.add('item-active');

            const infoDiv = document.createElement('div');
            infoDiv.className = 'cursor-pointer flex-1 truncate';
            infoDiv.onclick = () => loadEntry(item.uid);

            const titleEl = document.createElement('div');
            titleEl.className = 'font-medium text-slate-800 dark:text-slate-200 truncate';
            titleEl.textContent = item.title || '(bez n√°zvu)';

            const authorEl = document.createElement('div');
            authorEl.className = 'text-xs text-slate-500 dark:text-slate-400 truncate';
            authorEl.textContent = item.author || '(bez autora)';

            infoDiv.append(titleEl, authorEl);

            const delBtn = document.createElement('button');
            delBtn.className = 'opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 dark:text-red-500 dark:hover:text-red-400 p-1 ml-2 transition-opacity';
            delBtn.title = 'Smazat';
            delBtn.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"></path></svg>';
            delBtn.onclick = (e) => { e.stopPropagation(); deleteEntry(item.uid); };

            wrapper.append(infoDiv, delBtn);
            listContainer.appendChild(wrapper);
        });
    };

    // ‚îÄ‚îÄ Form Submit ‚îÄ‚îÄ
    if (form) {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            try {
                const formData = new FormData(form);
                const entry = Object.fromEntries(formData.entries());
                const currentId = document.getElementById('entry-id').value;

                if (currentId) {
                    const idx = db.findIndex(item => item.uid === currentId);
                    if (idx > -1) {
                        db[idx] = { ...entry, uid: currentId };
                        showToast('Aktualizov√°no');
                    } else {
                        entry.uid = uuid();
                        db.push(entry);
                        document.getElementById('entry-id').value = entry.uid;
                        showToast('Ulo≈æeno jako nov√Ω');
                    }
                } else {
                    entry.uid = uuid();
                    db.push(entry);
                    document.getElementById('entry-id').value = entry.uid;
                    showToast('Ulo≈æeno');
                }
                saveToDb();
                renderList(document.getElementById('entry-id').value);
            } catch(err) {
                console.error('Save error:', err);
                showToast('Chyba p≈ôi ukl√°d√°n√≠!');
            }
        });
    }

    // ‚îÄ‚îÄ Sidebar Save ‚îÄ‚îÄ
    const btnSaveSidebar = document.getElementById('btn-save-sidebar');
    if (btnSaveSidebar) {
        btnSaveSidebar.addEventListener('click', () => { if (form) form.requestSubmit(); });
    }

    // ‚îÄ‚îÄ Load Entry ‚îÄ‚îÄ
    const loadEntry = (uid) => {
        const data = db.find(item => item.uid === uid);
        if (!data) return showToast('Chyba: Polo≈æka nenalezena');

        if (form) {
            Object.keys(data).forEach(key => {
                const input = form.elements[key];
                if (input) {
                    input.value = data[key] || '';
                    if (input.tagName === 'TEXTAREA') autoResize(input);
                }
            });
            document.getElementById('entry-id').value = uid;
        }
        renderList(uid);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    window.loadEntry = loadEntry;

    // ‚îÄ‚îÄ Delete Entry ‚îÄ‚îÄ
    const deleteEntry = (uid) => {
        if (confirm('Opravdu smazat tento rozbor?')) {
            db = db.filter(item => item.uid !== uid);
            saveToDb();
            const entryIdInput = document.getElementById('entry-id');
            if (entryIdInput && entryIdInput.value === uid) resetForm();
        }
    };
    window.deleteEntry = deleteEntry;

    // ‚îÄ‚îÄ Reset ‚îÄ‚îÄ
    const resetForm = () => {
        if (form) form.reset();
        document.querySelectorAll('#analysis-form textarea').forEach(ta => autoResize(ta));
        const entryIdInput = document.getElementById('entry-id');
        if (entryIdInput) entryIdInput.value = '';
        renderList(null);
        showToast('Formul√°≈ô vyƒçi≈°tƒõn');
    };

    const btnReset = document.getElementById('btn-reset');
    if (btnReset) btnReset.onclick = resetForm;

    // ‚îÄ‚îÄ Nuke ‚îÄ‚îÄ
    const btnNuke = document.getElementById('btn-nuke');
    if (btnNuke) {
        btnNuke.onclick = () => {
            if (confirm('VAROV√ÅN√ç: Toto sma≈æe V≈†ECHNY ulo≈æen√© rozbory. Pokraƒçovat?')) {
                db = [];
                saveToDb();
                resetForm();
            }
        };
    }

    // ‚îÄ‚îÄ Import Modal ‚îÄ‚îÄ
    const importModal = document.getElementById('import-modal');
    const closeImportModal = () => {
        if (importModal) { importModal.classList.add('hidden'); importModal.classList.remove('flex'); }
        importedDataTemp = null;
        const fi = document.getElementById('import-file');
        if (fi) fi.value = '';
    };

    const btnImportCancel = document.getElementById('btn-import-cancel');
    if (btnImportCancel) btnImportCancel.onclick = closeImportModal;

    const btnImportMerge = document.getElementById('btn-import-merge');
    if (btnImportMerge) {
        btnImportMerge.onclick = () => {
            if (!importedDataTemp) return;
            let added = 0;
            importedDataTemp.forEach(newItem => {
                if (!db.find(existing => existing.uid === newItem.uid)) { db.push(newItem); added++; }
            });
            saveToDb();
            showToast('Slouƒçeno. P≈ôid√°no ' + added + ' nov√Ωch.');
            closeImportModal();
        };
    }

    const btnImportOverwrite = document.getElementById('btn-import-overwrite');
    if (btnImportOverwrite) {
        btnImportOverwrite.onclick = () => {
            if (!importedDataTemp) return;
            db = importedDataTemp;
            saveToDb();
            showToast('Datab√°ze kompletnƒõ p≈ôeps√°na.');
            closeImportModal();
        };
    }

    // ‚îÄ‚îÄ Backup ‚îÄ‚îÄ
    const btnBackup = document.getElementById('btn-backup');
    if (btnBackup) {
        btnBackup.onclick = () => {
            if (!db || !db.length) return showToast('≈Ω√°dn√° data k z√°loze.');
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = "rozbory_backup_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a);
            a.click();
            a.remove();
            showToast('Z√°loha sta≈æena');
        };
    }

    // ‚îÄ‚îÄ Import File ‚îÄ‚îÄ
    const importFile = document.getElementById('import-file');
    if (importFile) {
        importFile.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!Array.isArray(imported)) throw new Error("Not an array");
                    if (imported.length > 0 && typeof imported[0] !== 'object') throw new Error("Invalid items");

                    importedDataTemp = imported;
                    const ic = document.getElementById('import-count');
                    if (ic) ic.textContent = imported.length;
                    if (importModal) { importModal.classList.remove('hidden'); importModal.classList.add('flex'); }
                } catch (ex) {
                    alert('Chyba p≈ôi ƒçten√≠ souboru. Je to validn√≠ JSON z√°loha?\n' + ex.message);
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        };
    }

    // ‚îÄ‚îÄ LaTeX Generator ‚îÄ‚îÄ
    const latexMap = {
        '\\': '\\textbackslash{}',
        '&': '\\&', '%': '\\%', '$': '\\$', '#': '\\#',
        '_': '\\_', '{': '\\{', '}': '\\}',
        '~': '\\textasciitilde{}', '^': '\\textasciicircum{}'
    };

    const esc = (text) => {
        if (!text || typeof text !== 'string') return '-';
        // Escape special LaTeX characters
        let out = text.replace(/[\\&%$#_{}~^]/g, ch => latexMap[ch] || ch);
        // Replace newlines with LaTeX newlines
        out = out.replace(/\n/g, '\\newline ');
        return out;
    };

    const genRow = (label, value) => {
        return '\\textbf{' + label + ':} & \\parbox[t]{10.0cm}{' + esc(value) + '} \\\\ \n\\midrule\n';
    };

    const generateLatex = () => {
        if (!db.length) return alert('Nem√°m ≈æ√°dn√° data k exportu.');

        const sorted = [...db].sort((a, b) => {
            const tA = (a && a.title) ? a.title : '';
            const tB = (b && b.title) ? b.title : '';
            return tA.localeCompare(tB, 'cs');
        });

        // ‚îÄ‚îÄ OPRAVA: odstranƒõn \vspace{1cm}\rule na konci ka≈æd√© polo≈æky ‚îÄ‚îÄ
        // Str√°nky jsou oddƒõleny \clearpage na zaƒç√°tku, \rule tedy generovalo
        // pr√°zdn√© str√°nky a zbyteƒçnƒõ roztahovalo obsah.
        const content = sorted.map(d => '\n\\clearpage\n\\section*{' + esc(d.title) + ' (' + esc(d.author) + ')}\n\\addcontentsline{toc}{section}{' + esc(d.title) + ' (' + esc(d.author) + ')}\n\n\\begin{center}\n    \\large\\textbf{Charakteristika, anal√Ωza a interpretace umƒõleck√©ho textu}\n\\end{center}\n\\vspace{0.5cm}\n\n% PART I\n\\section*{TEXT A JEHO SLO≈ΩKY ‚Äì ƒåEHO SI V TEXTU V≈†√çMAT}\n\n\\subsection*{Z√°kladn√≠ √∫daje}\n\\begin{tabular}{p{5.5cm} p{10.0cm}}\n\\toprule\n' + genRow('Liter√°rn√≠ druh a ≈æ√°nr', d.kind_genre) + genRow('Kontext', d.context) + '\\bottomrule\n\\end{tabular}\n\n\\subsection*{Obsah}\n\\begin{tabular}{p{5.5cm} p{10.0cm}}\n\\toprule\n' + genRow('T√©ma', d.theme) + '\\multicolumn{2}{l}{\\textbf{Vƒõcn√Ω obsah:}} \\\\ \\midrule\n' + genRow('Postavy', d.characters) + genRow('Vypravƒõƒç / Lyrick√Ω subjekt', d.narrator) + genRow('ƒåasoprostor', d.setting) + genRow('Dƒõj/Dƒõn√≠', d.plot) + genRow('My≈°lenkov√Ω a emoƒçn√≠ obsah', d.thought_content) + '\\bottomrule\n\\end{tabular}\n\n\\subsection*{Forma}\n\\subsubsection*{Kompozice}\n\\begin{tabular}{p{5.5cm} p{10.0cm}}\n\\toprule\n' + genRow('ƒålenƒõn√≠ textu', d.composition_structure) + genRow('Slohov√© postupy', d.style_procedures) + genRow('Kompoziƒçn√≠ postupy', d.composition_procedures) + genRow('Kompoziƒçn√≠ principy', d.composition_principles) + '\\bottomrule\n\\end{tabular}\n\n\\subsubsection*{V√Ωrazov√© prost≈ôedky}\n\\begin{tabular}{p{5.5cm} p{10.0cm}}\n\\toprule\n' + genRow('Neverb√°ln√≠', d.nonverbal) + genRow('Verb√°ln√≠', d.verbal) + '\\bottomrule\n\\end{tabular}\n\n% PART II\n\\section*{KOMENT√Å≈ò ‚Äì JAK O TEXTU P≈òEM√ù≈†LET}\n\n\\subsection*{V√Ωklad (Smysl/V√Ωznam)}\n' + esc(d.interpretation) + '\n\n\\subsection*{Hodnocen√≠}\n' + esc(d.evaluation) + '\n').join('');

        // ‚îÄ‚îÄ OPRAVA: p≈ôid√°n \raggedbottom ‚Äî zabra≈àuje vertik√°ln√≠mu roztahov√°n√≠
        // obsahu na str√°nce, co≈æ zp≈Øsobovalo velk√© b√≠l√© mezery uvnit≈ô tabulek ‚îÄ‚îÄ
        const template = '\\documentclass[11pt, a4paper]{article}\n\\usepackage[a4paper, top=2.5cm, bottom=2.5cm, left=2cm, right=2cm]{geometry}\n\\usepackage{fontspec}\n\\usepackage[czech, bidi=basic, provide=*]{babel}\n\\babelprovide[import, onchar=ids fonts]{czech}\n\n\\renewcommand{\\familydefault}{\\sfdefault}\n\\raggedbottom\n\n\\usepackage{parskip, booktabs, fancyhdr, hyperref}\n\\hypersetup{colorlinks=true, linkcolor=blue, urlcolor=cyan, pdftitle={Maturitn√≠ Sborn√≠k}}\n\\pagestyle{fancy} \\fancyhead[L]{\\nouppercase{\\rightmark}} \\fancyhead[R]{\\thepage} \\fancyfoot{}\n\n\\begin{document}\n\\begin{titlepage} \\centering \\vspace*{4cm}\n{\\Huge \\bfseries MATURITN√ç SOUBOR DƒöL} \\\\[2cm]\n{\\Large Charakteristika, anal√Ωza a interpretace umƒõleck√©ho textu} \\\\[4cm]\n{\\large Vygenerov√°no aplikac√≠ Spr√°vce liter√°rn√≠ch rozbor≈Ø}\n\\end{titlepage}\n\\clearpage \\tableofcontents \\clearpage\n' + content + '\n\\end{document}';

        const outputCode = document.getElementById('output-code');
        if (outputCode) outputCode.value = template;

        const modal = document.getElementById('modal');
        if (modal) {
            const hasAck = localStorage.getItem('latex_ack') === 'true';
            const cb = document.getElementById('acknowledge-check');
            if (cb) cb.checked = hasAck;
            toggleButtons(hasAck);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    };

    const toggleButtons = (enabled) => {
        const bc = document.getElementById('btn-copy');
        const bo = document.getElementById('btn-overleaf');
        if (bc) bc.disabled = !enabled;
        if (bo) bo.disabled = !enabled;
    };

    const ackCheckbox = document.getElementById('acknowledge-check');
    if (ackCheckbox) {
        ackCheckbox.onchange = (e) => {
            toggleButtons(e.target.checked);
            localStorage.setItem('latex_ack', e.target.checked ? 'true' : 'false');
        };
    }

    const btnGenerate = document.getElementById('btn-generate');
    if (btnGenerate) btnGenerate.onclick = generateLatex;

    // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
    const showToast = (msg) => {
        const isDark = document.documentElement.classList.contains('dark');
        const t = document.createElement('div');
        t.className = 'fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg z-50 text-sm animate-bounce ' +
            (isDark ? 'bg-slate-700 text-slate-100' : 'bg-slate-800 text-white');
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => { if (t.parentNode) t.remove(); }, 2500);
    };

    // ‚îÄ‚îÄ Clipboard ‚îÄ‚îÄ
    const copyToClipboard = async () => {
        const txt = document.getElementById('output-code');
        if (!txt) return false;
        txt.select();
        try {
            await navigator.clipboard.writeText(txt.value);
            return true;
        } catch (err) {
            try { document.execCommand('copy'); return true; }
            catch(e2) { return false; }
        }
    };

    const btnCopyEl = document.getElementById('btn-copy');
    if (btnCopyEl) {
        btnCopyEl.onclick = async () => {
            await copyToClipboard();
            showToast('Zkop√≠rov√°no!');
        };
    }

    const btnOverleafEl = document.getElementById('btn-overleaf');
    if (btnOverleafEl) {
        btnOverleafEl.onclick = async () => {
            await copyToClipboard();
            showToast('Zkop√≠rov√°no! Otev√≠r√°m Overleaf...');
            setTimeout(() => { window.open('https://www.overleaf.com/project', '_blank'); }, 800);
        };
    }

    const btnCloseModal = document.getElementById('btn-close-modal');
    if (btnCloseModal) {
        btnCloseModal.onclick = () => {
            const m = document.getElementById('modal');
            if (m) { m.classList.add('hidden'); m.classList.remove('flex'); }
        };
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
    try {
        initData();
        renderList();
        console.log('‚úÖ Spr√°vce liter√°rn√≠ch rozbor≈Ø ‚Äì naƒçteno OK, polo≈æek:', db.length);
    } catch(e) {
        console.error('‚ùå Init failed:', e);
        showToast('Kritick√° chyba p≈ôi startu!');
    }
});
</script>
</body>
</html>
